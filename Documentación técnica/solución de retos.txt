================================================================================
DOCUMENTACIÓN TÉCNICA: Solución a los retos
================================================================================

PROYECTO: Sistema Embebido para Triaje de Lesiones Cutáneas
PLATAFORMA: Raspberry Pi 5 + Cámara (Módulo 3)
MODELO: EfficientNetB0 (Custom Head) + TFLite Float16
ESTADO: Validación Exitosa (Recall Melanoma > 80%)

================================================================================
1. SEGMENTACIÓN ADAPTATIVA (NUEVO ENFOQUE)
================================================================================

1.1 EL DESAFÍO DE LA ILUMINACIÓN
--------------------------------
En la versión inicial, se utilizaron umbrales fijos en el espacio de color YCbCr 
(Cb: [77-127], Cr: [133-173]). Sin embargo, las pruebas de campo revelaron una 
falla crítica:
- La variabilidad en la temperatura de color de la luz LED del dermatoscopio 
  hacía que pieles sanas se salieran de estos rangos fijos.
- Resultado: Segmentación fallida (máscaras negras o completas).

1.2 SOLUCIÓN: CALIBRACIÓN DINÁMICA
----------------------------------
Se implementó un algoritmo de **Segmentación YCbCr Adaptativa**.
En lugar de "números mágicos", el sistema se calibra automáticamente con cada foto:

1. **Muestreo de Referencia:** El algoritmo extrae parches de 20x20 píxeles de 
   las 4 esquinas interiores de la imagen (donde estadísticamente hay piel sana).
2. **Cálculo de Mediana:** Se calcula la mediana de los canales Cb y Cr de esas 
   muestras para encontrar el "color base" de la piel del paciente bajo esa luz específica.
3. **Ancho de Banda Elástico:** Se definen los umbrales de segmentación como:
   [Mediana - 25, Mediana + 25].
   
   Esto permite que el sistema funcione igual de bien en pieles pálidas con luz fría 
   que en pieles oscuras con luz cálida.

1.3 ELIMINACIÓN DE BORDES (VIGNETTE)
------------------------------------
Los dermatoscopios generan un marco negro circular (viñeteado). Los algoritmos 
de umbralización simples confundían este negro con melanomas.
- **Solución:** Máscara ROI (Region of Interest) Circular.
- Se aplica una intersección lógica (AND) entre la detección YCbCr y un círculo 
  generado matemáticamente que cubre el 90% central de la lente.
- Esto elimina el ruido perimetral sin alterar la morfología irregular de la lesión central.

================================================================================
2. ARQUITECTURA DEL MODELO DE CLASIFICACIÓN
================================================================================

2.1 SELECCIÓN DE BACKBONE: EfficientNetB0
-----------------------------------------
Se eligió EfficientNetB0 por su óptimo balance Accuracy/Recursos:
- Parámetros: ~4 Millones (vs 25M de ResNet50).
- Input: 224x224.
- Estrategia: Transfer Learning desde pesos ImageNet.

2.2 EL DESCUBRIMIENTO DE LA ESCALA (FIX CRÍTICO)
------------------------------------------------
Durante el desarrollo, se identificó un error que estancaba el aprendizaje (Loss ~1.10).
- **El Error:** Se aplicaba una normalización `Rescaling(1./255)` estandar.
- **La Realidad:** EfficientNet espera valores de píxeles crudos [0-255]. Al normalizar 
  a [0-1], la señal de entrada era tan débil que la red no activaba sus neuronas.
- **Corrección:** Se eliminó la capa de re-escalado, permitiendo el flujo de tensores 
  uint8/float32 en rango 0-255. Esto disparó el Accuracy inmediatamente.

2.3 CABEZAL DE CLASIFICACIÓN (CUSTOM HEAD)
------------------------------------------
Para adaptar la red al problema de 3 clases (Melanoma, Nevo, Otro), se diseñó:
1. **GlobalAveragePooling2D**: Reducción espacial.
2. **BatchNormalization**: Estabilización de pesos (Crítico para convergencia).
3. **Dropout (0.2)**: Prevención de sobreajuste.
4. **Dense (Softmax)**: 3 neuronas de salida.

================================================================================
3. ESTRATEGIA DE ENTRENAMIENTO: BALANCEO FÍSICO
================================================================================

3.1 EL PROBLEMA DEL DESBALANCE
------------------------------
El dataset HAM10000 es extremadamente desbalanceado:
- Nevos (Benignos): ~6700 imágenes.
- Melanomas: ~1100 imágenes.
- Inicialmente, el modelo optimizaba prediciendo siempre "Nevo", logrando un 
  Recall de Melanoma del 0%.

3.2 SOLUCIÓN: OVERSAMPLING DINÁMICO (INFINITE REPEAT)
-----------------------------------------------------
Los métodos tradicionales (Class Weights) no fueron suficientes. Se implementó una 
estrategia de **Balanceo Físico en el Pipeline de Datos**:

1. **Separación:** Se dividió el dataset en 3 sub-datasets (Mel, NV, Other).
2. **Infinite Repeat:** Se aplicó `.repeat()` a cada sub-dataset para convertirlos 
   en flujos de datos infinitos.
3. **Muestreo Equitativo:** Se utilizó `tf.data.Dataset.sample_from_datasets` con 
   pesos [0.33, 0.33, 0.33].

**Resultado:** El modelo "ve" artificialmente la misma cantidad de melanomas que 
de nevos. Esto forzó al modelo a aprender características reales de malignidad, 
elevando el Recall de 0% a >80%.

================================================================================
4. IMPLEMENTACIÓN EN BORDE (TENSORFLOW LITE)
================================================================================

4.1 POR QUÉ TFLITE EN RASPBERRY PI 5
------------------------------------
Aunque la Raspberry Pi 5 tiene potencia considerable, TFLite es mandatorio por:
1. **Latencia Crítica:** El modelo .h5 estándar (Keras) tiene un overhead de carga 
   alto. TFLite reduce el tiempo de inferencia de ~300ms a ~50ms.
2. **Gestión Térmica:** Menor uso de CPU implica menor temperatura en un dispositivo 
   cerrado (handheld).
3. **Portabilidad:** Elimina la dependencia del ecosistema pesado de TensorFlow completo 
   en el entorno de producción.

4.2 CUANTIZACIÓN FLOAT16
------------------------
Se aplicó cuantización Float16 durante la conversión:
- Reduce el tamaño del modelo a la mitad (~5MB).
- Mantiene la precisión casi idéntica al modelo Float32 (vital para diagnósticos médicos).
- Aprovecha las instrucciones vectoriales de la CPU ARM Cortex-A76 de la Pi 5.

================================================================================
5. RESULTADOS FINALES DE VALIDACIÓN
================================================================================

Métricas obtenidas en el conjunto de Test (Imágenes nunca vistas):

| Métrica | Valor | Interpretación Clínica |
| :--- | :--- | :--- |
| **Recall (Melanoma)** | **83.31%** | Detecta 8.3 de cada 10 melanomas reales. (Alta Seguridad) |
| **Precision (Nevo)** | **95.0%** | Solo 5% de falsas alarmas en lunares sanos. (Eficiencia) |
| **Accuracy Global** | **85.0%** | Rendimiento general robusto. |

Estos resultados validan la viabilidad del dispositivo como herramienta de 
triaje asistido.

================================================================================